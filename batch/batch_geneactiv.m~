%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% DEMO BATCH SCRIPT
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% specify path to folder here. This folder should contain 4 subfolders,
% called bin, mat, csd and txt.
%   - ./bin contains all the raw data files
%   - ./mat will store all the converted mat files
%   - ./csd contains all the sleep consensus diaries (according to supplied
%     format)
%   - ./txt will save all the sleep results from the every scd file

% CHANGE THIS: data folder
datapath = 'C:\path\to\your\data\';

addpath(genpath('C:\path\to\actant'));

cd(datapath) 

addpath('./bin');
addpath('./mat');
addpath('./scd');
addpath('./txt');

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% BATCH CONVERT ALL BIN FILES TO MAT FILES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% BATCH PROCESS ALL MAT FILES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% specify algorithm properties
args1{1,1} = 'Algorithm';   args1{1, 2} = 'oakley';
args1{2,1} = 'Method';      args1{2, 2} = 'i';
args1{3,1} = 'Sensitivity'; args1{3, 2} = 'm';
args1{4,1} = 'Snooze';      args1{4, 2} = 'on';
args1{5,1} = 'Time window'; args1{5, 2} = 10; 

% create list with .mat files
mat_files = dir('./mat/*.mat');

% create list with sleep consensus diaries (.csv, COMMA seperated, not TAB or SEMICOLON) files
scd_files = dir('./scd/*.csv');

% check the number of files in the SCD folder, which will be limiting
% factor

% IMPORTANT NOTICE:here write regular expression to load all files with subject ID format of
% 4 digits; e.g. 0001 OR keep file names consistent.
% for now I assume that file 1 in the cds_files list, corresponds with file 1
% in the mat_files list. This works if both folders contain incremental
% numbering e.g. 0001.csv, 0002.csv,... and 0001.mat, 0002.mat,...


% loop through all files, loading the mat and csv file for each subject and
% then processing the data, and storing the results (output called vals) to
% a csv file

for file = 1:numel(scd_files)
    
    % load only the acc_z variable from the data file
    load(mat_files(file).name, 'acc_z')
    
    % load SCD file
    % this should be a .csv file (comma seperated) with 8 columns 
    % columns 1 (date), 3 (sleep onset) and 7 (out of bed) are used  
    fid = fopen(scd_files(file).name, 'r');
    tmp = textscan(fid, '%s%s%s%s%s%s%s%s',...
            'Headerlines', 1,...
            'Delimiter', ',');
    fclose(fid);
    
    args2 = {};
    % restructure cell to daysx8 instead of tmp(1:8)(daysx1)
    for ndays = 1:numel(tmp{1})
        for column = 1:8
            args2(ndays,column) = tmp{column}(ndays);
        end
    end
   
    % pass the acc_z, args1 and args2 to the algorithm
    [~, vals] = actant_oakley(acc_z, args1, args2);
    
    % open file to write data to 
    fid = fopen(['./txt/' scd_files(file).name(1:end-4) '.txt'], 'w');
    
    % put in headers, all strings
    fprintf(fid, '%s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %f\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\t %s\n',...
        vals{:,1});
    
    % load columns from vals and store as rows in txt, both strings and numbers
    for i = 2:size(vals, 2)
        fprintf(fid, '%s\t %s\t %s\t %s\t %f\t %s\t %f\t %s\t %f\t %f\t %f\t %f\t %f\t %f\t %f\t %f\t %f\t %f\t %f\t %f\t %f\n',...
            vals{:,i});
    end
    fclose(fid);
    
    % clear workspace variable
    clear acc_z args2
    
end



%% get the mean temperature per 30 second epoch?
% load temp data

% average temperature per 30 sec epoch

% write to csv file



%% get the activity classification data
% remove non-wear periods

% interpolate

% classify
